image: rust

stages:
  - style
  - build
  - release

.shared_windows_runners:
  tags:
  - shared-windows
  - windows
  - windows-1809

.macos_buildcloud_runners:
  tags:
    - shared-macos-amd64
  image: macos-11-xcode-12

cache:
  key: $CI_COMMIT_REF_NAME-$CI_JOB_NAME
  paths:
    - target
    - .cargo

style:
  stage: style
  script:
    - rustup component add clippy rustfmt
    - rustc --version
    - cargo version
    - cargo fmt -- --check
    - cargo clippy

build-windows:
  stage: build
  extends: .shared_windows_runners
  before_script:
    - choco feature enable -n=allowGlobalConfirmation
    - choco install rust
  script:
    - cargo build --release 
    - cargo test 
  artifacts:
    paths:
      - target/release/automattermostatus.exe
    expire_in: 7 day


build-linux:
  stage: build
  script:
    - cargo build --release 
    - cargo test 
  artifacts:
    paths:
      - target/release/automattermostatus
    expire_in: 7 day

build-linux-beta:
  stage: build
  before_script:
    - echo nightly > rust-toolchain
  script:
    - cargo build --release 
    - cargo test 

build-linux-nightly:
  stage: build
  before_script:
    - echo nightly > rust-toolchain
  script:
    - cargo build --release 
    - cargo test 

# Not enabled for now
.build-mac:
    stage: build
    extends: .macos_buildcloud_runners
    before_script:
      - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
      - rustup install stable
    script:
        - cargo build --release 
        - cargo test
    artifacts:
      paths:
        - target/release/automattermostatus.exe

release:
  stage: release
  needs: [build-linux, build-windows]
  dependencies: [build-linux, build-windows]
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+.*$/
  script:
    - sed -ne '/^# '${CI_COMMIT_TAG}' *$/,/^# v[0-9]\+\.[0-9]\+\.[0-9]/p' CHANGELOG.md | head -n-2 > description.txt
    - echo 'release job'
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: './description.txt'
    tag_name: '$CI_COMMIT_TAG'                                       # elsewhere in the pipeline.
    ref: '$CI_COMMIT_TAG'
#    assets: # Optional, multiple asset links
#      links:
#        - name: 'asset1'
#          url: 'https://example.com/assets/1'
#        - name: 'asset2'
#          url: 'https://example.com/assets/2'
#          filepath: '/pretty/url/1' # optional
#          link_type: 'other' # optional

